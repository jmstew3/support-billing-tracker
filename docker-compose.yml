services:
  mysql:
    image: mysql:8.0
    container_name: support-billing-tracker-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: support_billing_tracker
      MYSQL_USER: ${MYSQL_USER:-thaduser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-thadpassword}
    ports:
      - "127.0.0.1:${MYSQL_PORT:-3307}:3306"  # Localhost only - not accessible from network
    volumes:
      - ${MYSQL_DATA_PATH:-./mysql_data}:/var/lib/mysql
      - ./backend/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./backend/db/seed_requests.sql:/docker-entrypoint-initdb.d/02-seed-requests.sql:ro
    networks:
      - velocity-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: support-billing-tracker-backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${MYSQL_USER:-thaduser}
      DB_PASSWORD: ${MYSQL_PASSWORD:-thadpassword}
      DB_NAME: ${DB_NAME:-support_billing_tracker}
      PORT: 3011
      NODE_ENV: ${NODE_ENV:-development}
      ENABLE_SCHEDULER: ${ENABLE_SCHEDULER:-false}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      DATA_PATH: ${DATA_PATH:-./data}
      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-1h}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@peakonedigital.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-PeakonBilling2025}
      # External APIs
      VITE_TWENTY_API_URL: ${VITE_TWENTY_API_URL:-http://localhost:3000}
      VITE_TWENTY_API_TOKEN: ${VITE_TWENTY_API_TOKEN:-}
      VITE_TWENTY_USE_MOCK: ${VITE_TWENTY_USE_MOCK:-true}
      VITE_FLUENT_API_URL: ${VITE_FLUENT_API_URL:-}
      VITE_FLUENT_API_USERNAME: ${VITE_FLUENT_API_USERNAME:-}
      VITE_FLUENT_API_PASSWORD: ${VITE_FLUENT_API_PASSWORD:-}
      VITE_FLUENT_DATE_FILTER: ${VITE_FLUENT_DATE_FILTER:-2025-09-20}
    ports:
      - "${BACKEND_PORT:-3011}:3011"  # Exposed for local development
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./data:/data:ro
    networks:
      - velocity-network
      - traefik-general
    labels:
      - "traefik.enable=true"
      # Main API route
      - "traefik.http.routers.billing-overview-api.rule=Host(`velocity.peakonedigital.com`) && PathPrefix(`/billing-overview-api`)"
      - "traefik.http.routers.billing-overview-api.entrypoints=web"
      - "traefik.http.services.billing-overview-api.loadbalancer.server.port=3011"
      - "traefik.docker.network=traefik-general"
      - "traefik.http.middlewares.billing-overview-api-strip.stripprefix.prefixes=/billing-overview-api"
      # Apply strip prefix middleware only (JWT auth handled by backend, removed file-based middlewares that may not exist)
      - "traefik.http.routers.billing-overview-api.middlewares=billing-overview-api-strip"
      # Client Portal API route
      - "traefik.http.routers.client-portal-api.rule=Host(`portal.peakonedigital.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.client-portal-api.entrypoints=web"
      - "traefik.http.services.client-portal-api.loadbalancer.server.port=3011"
      - "traefik.http.middlewares.client-portal-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.client-portal-api.middlewares=client-portal-api-strip"
    command: npm start

  mysql-backup:
    build:
      context: ./backup
      dockerfile: Dockerfile
    container_name: support-billing-tracker-backup
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: ${MYSQL_USER:-thaduser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-thadpassword}
      MYSQL_DATABASE: ${DB_NAME:-support_billing_tracker}
      TZ: America/New_York
      BACKUP_ON_STARTUP: ${BACKUP_ON_STARTUP:-false}
    volumes:
      - ${BACKUP_PATH:-./mysql_data_backup}:/backups
    networks:
      - velocity-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: support-billing-tracker-frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3011/api}
      NODE_ENV: development
      VITE_HMR_DISABLED: true
      VITE_TWENTY_API_URL: ${VITE_TWENTY_API_URL:-http://localhost:3000}
      VITE_TWENTY_API_TOKEN: ${VITE_TWENTY_API_TOKEN:-}
      VITE_TWENTY_USE_MOCK: ${VITE_TWENTY_USE_MOCK:-true}
      VITE_PORT: ${VITE_PORT:-5173}
      VITE_HMR_PORT: ${VITE_HMR_PORT:-5173}
      VITE_HMR_HOST: ${VITE_HMR_HOST:-localhost}
      VITE_PUBLIC_API_URL: ${VITE_PUBLIC_API_URL:-}
      VITE_BASE_PATH: ${VITE_BASE_PATH:-/billing-overview}
    ports:
      - "${FRONTEND_PORT:-5173}:${VITE_PORT:-5173}"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - ./frontend/public:/app/public
    networks:
      - velocity-network
      - traefik-general
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.billing-overview.rule=Host(`velocity.peakonedigital.com`) && PathPrefix(`/billing-overview`)"
      - "traefik.http.routers.billing-overview.entrypoints=web"
      - "traefik.http.services.billing-overview.loadbalancer.server.port=${VITE_PORT:-5173}"
      - "traefik.docker.network=traefik-general"
      # No middleware - JWT auth handled by backend, login screen by frontend
      # Client Portal frontend route
      - "traefik.http.routers.client-portal.rule=Host(`portal.peakonedigital.com`)"
      - "traefik.http.routers.client-portal.entrypoints=web"
      - "traefik.http.services.client-portal.loadbalancer.server.port=${VITE_PORT:-5173}"
    command: npm run dev:docker

networks:
  velocity-network:
    driver: bridge
  traefik-general:
    external: true

# Note: Using bind mount for MySQL data instead of named volume
# This makes it easier to backup and migrate on NAS systems
# The mysql_data directory will be created in your project root
# To use a named volume instead, uncomment the following:
# volumes:
#   mysql_data:
#     driver: local